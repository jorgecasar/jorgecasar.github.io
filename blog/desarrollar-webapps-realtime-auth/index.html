<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Desarrollar Webapps Realtime: Auth - Jorge del Casar</title>
  <meta name="author" content="Jorge del Casar">

  
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://jorgecasar.github.io/blog/desarrollar-webapps-realtime-auth">
  <link href="/favicon.png" type="image/png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="Jorge del Casar" type="application/atom+xml">

  <link href="/assets/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/assets/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css">
<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">


  <script src="/javascripts/libs/jquery/jquery-2.0.3.min.js"></script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-26360643-5']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

  <body   >
    <div id="wrap">
      <header role="banner">
        <nav class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Jorge del Casar</a>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li class="active">
                    <a href="/">Blog</a>
                </li>
                <li >
                    <a href="/blog/archives">Archives</a>
                </li>
                <li >
                    <a href="/repos">Repos</a>
                </li>
                <li >
                    <a href="/talks">Talks</a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a class="subscribe-rss" href="/atom.xml" title="subscribe via RSS">
                        <span class="visible-xs">RSS</span>
                        <img class="hidden-xs" src="/images/rss.png" alt="RSS">
                    </a>
                </li>
                
            </ul>
            
                <form class="search navbar-form navbar-right" action="http://google.com/search" method="GET">
                    <input type="hidden" name="q" value="site:jorgecasar.github.io">
                    <div class="form-group">
                        <input class="form-control" type="text" name="q" placeholder="Search">
                    </div>
                </form>
            
        </div>
    </div>
</nav>


      </header>
      <div id="main" class="container">
        <div id="content">
          <div class="row">
  <div class="page-content col-md-9">
    <article class="hentry" role="article">
      
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2014-01-18T12:40:04+01:00" pubdate data-updated="true">Jan 18<span>th</span>, 2014</time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="http://jorgecasar.github.io">Comments</a>
        
      </p>
    
    
    <h1 class="entry-title">
        Desarrollar Webapps Realtime: Auth
        
    </h1>
    
  </header>


<div class="entry-content clearfix"><div class="alert alert-info">
	<p>Código en GitHub: <a href="https://github.com/jorgecasar/building-realtime-webapp">building-realtime-webapp</a>. Release: <code>auth</code>.</p>
	<p>Entorno de desarrollo en Heroku: <a href="http://building-realtime-webapp-dev.herokuapp.com/">building-realtime-webapp</a>.</p>
</div>

<p><img class="center" src="http://sailsjs.org/images/image_squidhome.png" title="Designed for developers by Giant Squid" alt="Giant Squid" /></p>

<ul id="markdown-toc">
  <li><a href="#cambios-en-el-layout">Cambios en el layout</a></li>
  <li><a href="#autenticacin-bsica">Autenticación básica</a>    <ul>
      <li><a href="#accin-auth">Acción <code>auth</code></a></li>
      <li><a href="#accin-login">Acción <code>Login</code></a></li>
      <li><a href="#accin-logout">Acción <code>Logout</code></a></li>
    </ul>
  </li>
  <li><a href="#polticas-de-acceso">Políticas de acceso</a>    <ul>
      <li><a href="#poltica-usuario-autenticado">Política usuario autenticado</a></li>
      <li><a href="#poltica-de-poder-administar-usuario">Política de poder Administar usuario</a></li>
    </ul>
  </li>
</ul>

<p>Siguiendo con la saga de “Desarrollar Webapps Realtime” y depués de haber visto <a href="/blog/desarrollar-webapps-realtime-creacion">Cómo empezar a crear un Webapp real-time</a> y <a href="/blog/desarrollar-webapps-realtime-usuarios">cómo crear usuarios siguiendo el patrón MVC</a>, le toca el turno a cómo autenticar a los usuarios en nuestra plataforma. Para ello vamos a hacerlo primero con nuestros propios medios para entender algunos conceptos y después lo haremos usando <a href="http://passportjs.org/">Passport for Node</a>.
<!-- more --></p>

<h2 id="cambios-en-el-layout">Cambios en el layout</h2>

<p>Lo primero que vamos a hacer es cambiar la barra de navegación añadiendo el botón de login cuando el usuario no esté autenticado y su correo y el boton de logout cuando si lo esté. Para ello debemos comprobar la variable <code>session.authenticated</code> que estableceremos en el controlador. Estas líneas las añadimos después de nuestro menú de navegación, <code>&lt;ul class="nav navbar-nav"&gt;[…]&lt;/ul&gt;</code>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>layout.ejs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="html"><span class="line"><span class="err">&lt;</span>% if( session.authenticated ) { %&gt;
</span><span class="line"><span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav navbar-nav navbar-right&quot;</span><span class="nt">&gt;</span>
</span><span class="line">	<span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;/user/&lt;%= session.user.id %&gt;&quot;</span><span class="nt">&gt;</span><span class="err">&lt;</span>%= session.user.email %&gt;<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
</span><span class="line">	<span class="nt">&lt;li&gt;</span>
</span><span class="line">		<span class="nt">&lt;form</span> <span class="na">class=</span><span class="s">&quot;navbar-form&quot;</span> <span class="na">action=</span><span class="s">&quot;/user/logout&quot;</span> <span class="na">method=</span><span class="s">&quot;POST&quot;</span><span class="nt">&gt;</span>
</span><span class="line">			<span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">class=</span><span class="s">&quot;btn btn-danger&quot;</span> <span class="na">title=</span><span class="s">&quot;&lt;%= __(&#39;Logout&#39;)%&gt;&quot;</span><span class="nt">&gt;</span>
</span><span class="line">				<span class="err">&lt;</span>%= __(&#39;Logout&#39;)%&gt;
</span><span class="line">				<span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;glyphicon glyphicon-log-out&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
</span><span class="line">			<span class="nt">&lt;/button&gt;</span>
</span><span class="line">		<span class="nt">&lt;/form&gt;</span>
</span><span class="line">	<span class="nt">&lt;/li&gt;</span>
</span><span class="line"><span class="nt">&lt;/ul&gt;</span>
</span><span class="line"><span class="err">&lt;</span>% } else { %&gt;
</span><span class="line"><span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav navbar-nav navbar-right&quot;</span><span class="nt">&gt;</span>
</span><span class="line">	<span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;/user/new&quot;</span><span class="nt">&gt;&lt;span</span> <span class="na">class=</span><span class="s">&quot;glyphicon glyphicon-edit&quot;</span><span class="nt">&gt;&lt;/span&gt;</span> Sign up<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
</span><span class="line">	<span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;/user/auth&quot;</span><span class="nt">&gt;&lt;span</span> <span class="na">class=</span><span class="s">&quot;glyphicon glyphicon-log-in&quot;</span><span class="nt">&gt;&lt;/span&gt;</span> Login<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
</span><span class="line"><span class="nt">&lt;/ul&gt;</span>
</span><span class="line"><span class="err">&lt;</span>% } %&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Si os fijáis para crear un nuevo usuario y para la página de autenticación he usado enlaces pero para el log out he usado un formulario con un botón. Esto es porque en los enlaces se utilizan para navegar y los botones para acciones.</p>

<h2 id="autenticacin-bsica">Autenticación básica</h2>

<p>Para gestionar las sesiones necesitaremos las acciones <code>auth</code>, <code>login</code> y <code>logout</code>. Estas acciones las vamos a añadir en <code>UserController</code>, aunque podrían ir en un nuevo controlador llamado <code>SessionController</code>. Como posteriormente vamos a implementar la autenticación con Passport lo moveremos a un controlador especifico llamado <code>AuthController</code>.</p>

<h3 id="accin-auth">Acción <code>auth</code></h3>

<p>Esta acción simplemente nos devolverá una vista con el formulario de autenticación. Así que habrá que crear la vista <code>/view/user/auth.ejs</code> en la que le solicitaremos el email y la contraseña. Esta vista es muy similar a <code>/view/user/new.ejs</code>, así que podemos copiar y pegar el contenido y hacemos un par de cambios:</p>

<ul>
  <li>El action del from ya no es <code>/user/create</code> sino <code>/user/login</code>.</li>
  <li>Los 3 textos (migas de pan, título y botón) donde pone ‘Create user’ ponemos ‘Auth user’.</li>
</ul>

<p>Y en el controlador copiamos la acción new sin hacer ningún cambio.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>auth action in UserController.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">auth</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">	<span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">view</span><span class="p">();</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Ahora podemos lanzar el servidor y comprobar que la url <a href="http://localhost:1337/user/auth">http://localhost:1337/user/auth</a> funciona correctamente.</p>

<h3 id="accin-login">Acción <code>Login</code></h3>

<p>En esta acción hay un poco más de chicha, ya que tendremos que buscar el usuario mediante el email, comparar la contraseña y guardar una variable de sessión.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>login action in UserController.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">login</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">email</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)}).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span> <span class="nx">foundUser</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">){</span>
</span><span class="line">		<span class="k">if</span> <span class="p">(</span> <span class="nx">err</span> <span class="o">||</span> <span class="o">!</span><span class="nx">user</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/auth&#39;</span><span class="p">);</span>
</span><span class="line">		<span class="nx">require</span><span class="p">(</span><span class="s1">&#39;bcrypt&#39;</span><span class="p">).</span><span class="nx">compare</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">),</span> <span class="nx">user</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">valid</span><span class="p">){</span>
</span><span class="line">			<span class="k">if</span><span class="p">(</span><span class="nx">err</span> <span class="o">||</span> <span class="o">!</span><span class="nx">valid</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/auth&#39;</span><span class="p">);</span>
</span><span class="line">			<span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">authenticated</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class="line">			<span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">user</span><span class="p">;</span>
</span><span class="line">			<span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/user/&#39;</span> <span class="o">+</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
</span><span class="line">		<span class="p">});</span>
</span><span class="line">	<span class="p">});</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Si lanzamos el servidor de nuevo y probamos a rellenar el formulario con uno de los usuarios previamente creados, vemos como nos redirecciona a la página del usuario y nos reemplaza los botones de ‘Ingresar’ y ‘Resistrarse’ por el email del usuario y un botón de ‘Desconectar’.</p>

<p>Tenemos que tener en cuenta que cunado se crea un usuario podemos considerarlo autenticado. O bien esperar a que verifique su mail, pero como de momento no enviamos mail. Consideraremos al usuario autenticado al crear la nueva cuenta, asignando los valores a la sesión antes de enviar la respuesta:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>create action in UserController.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">create</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">User</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">all</span><span class="p">(),</span> <span class="kd">function</span> <span class="nx">createdUser</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">){</span>
</span><span class="line">		<span class="p">[</span><span class="err">…</span><span class="p">]</span>
</span><span class="line">		<span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">authenticated</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class="line">		<span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">user</span><span class="p">;</span>
</span><span class="line">		<span class="p">[</span><span class="err">…</span><span class="p">]</span>
</span><span class="line">	<span class="p">});</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="accin-logout">Acción <code>Logout</code></h3>

<p>En este caso, es mucho más facil, simplemente destruimos la sesión y redirigimos al usuario a la home.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>logout action in UserController.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">logout</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
</span><span class="line">	<span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
</span><span class="line">	<span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Volvemos a lanzar el servidor, hacemos login y una vez en la página del usuario pulsamos el botón de ‘Desconectar’ para ver como salimos de la sessión y vuelven a aparecer los botones de ‘Ingresar’ y ‘Resistrarse’.</p>

<div class="alert alert-info">
	<p>Commit en GitHub: <a href="https://github.com/jorgecasar/building-realtime-webapp/commit/01e14ef420a8d238c08f9ee4ece91f3df8b08737">01e14ef420: Authentication on UserController: auth, login and logout actions</a>.</p>
</div>

<h2 id="polticas-de-acceso">Políticas de acceso</h2>

<div class="alert alert-success">
	<p>Recomiendo echarle un ojo a la <a href="http://sailsjs.org/#!documentation/policies">Documentación de Sails sobre Políticas</a>.</p>
</div>

<p>Autenticar a un usuario tiene la misión principal de conceder o denegar el acceso a algunas partes de nuestra aplicación. Para ello haremos uso de las políticas (policies). Estas políticas las declaramos en el directorio <code>/api/policies</code>.</p>

<h3 id="poltica-usuario-autenticado">Política usuario autenticado</h3>

<p>Por defecto Sails nos incluye la política <code>isAuthenticated.js</code>. La cual hace uso de la variable de sessión que establecemos a <code>true</code> cuando el usuario se identifica. Una politica se declara como un módudo y ejecuta la función de callbac <code>next</code> cunado se concede acceso o devuelve forbidden en caso contrario.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>/api/policies/isAuthenticated.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">	<span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">authenticated</span><span class="p">)</span>
</span><span class="line">		<span class="k">return</span> <span class="nx">next</span><span class="p">();</span>
</span><span class="line">	<span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">forbidden</span><span class="p">(</span><span class="s1">&#39;You are not permitted to perform this action.&#39;</span><span class="p">);</span>
</span><span class="line"><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Ahora que tenemos la políca definida debemos aplicarla a alguna URL o acción del controlador. Para ello accedemos a <code>/config/policies.js</code> donde definiremos las políticas que se aplcian en cada caso.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>/config/policies.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">policies</span> <span class="o">=</span> <span class="p">{</span>
</span><span class="line">	<span class="s1">&#39;*&#39;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class="line">	<span class="nx">UserController</span><span class="o">:</span> <span class="p">{</span>
</span><span class="line">		<span class="s1">&#39;*&#39;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class="line">		<span class="nx">find</span><span class="o">:</span> <span class="s1">&#39;isAuthenticated&#39;</span><span class="p">,</span>
</span><span class="line">		<span class="nx">update</span><span class="o">:</span> <span class="s1">&#39;isAuthenticated&#39;</span><span class="p">,</span>
</span><span class="line">		<span class="nx">destroy</span><span class="o">:</span> <span class="s1">&#39;isAuthenticated&#39;</span><span class="p">,</span>
</span><span class="line">		<span class="nx">edit</span><span class="o">:</span> <span class="s1">&#39;isAuthenticated&#39;</span><span class="p">,</span>
</span><span class="line">		<span class="nx">logout</span><span class="o">:</span> <span class="s1">&#39;isAuthenticated&#39;</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Con esto estamos permitiendo el acceso a todas las acciones del <code>UserController</code>, y en algunos casos (find, update, destroy, edit, logut), le pedimos que estén autenticados. Personalmente prefiero aplicar las políticas partiendo de la restricción, es decir, para todas las acciones hay que estar autenticado salvo para las que definamos como abiertas. Quedaría de esta manera:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>/config/policies.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">policies</span> <span class="o">=</span> <span class="p">{</span>
</span><span class="line">	<span class="s1">&#39;*&#39;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class="line">	<span class="nx">UserController</span><span class="o">:</span> <span class="p">{</span>
</span><span class="line">		<span class="s1">&#39;*&#39;</span><span class="o">:</span> <span class="s1">&#39;isAuthenticated&#39;</span><span class="p">,</span>
</span><span class="line">		<span class="nx">create</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class="line">		<span class="k">new</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class="line">		<span class="nx">auth</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class="line">		<span class="nx">login</span><span class="o">:</span> <span class="kc">true</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>En ambos casos permitimos el acceso a las mismas url, pero si añadimos una acción al controlador, estará protegida por defecto.</p>

<div class="alert alert-info">
	<p>Commit en GitHub: <a href="https://github.com/jorgecasar/building-realtime-webapp/commit/e58ea71cc3f566287e67e64eaabbf1838652912c">e58ea71cc3: isAuthenticated policy</a>.</p>
</div>

<h3 id="poltica-de-poder-administar-usuario">Política de poder Administar usuario</h3>

<p>Para los casos de editar y eliminar, debemos asegurarnos de que el usuario es él mismo, para evitar que un usuario pueda editar o eliminar cuentas que no son la suya. Más adelante podremos establecer perfiles administradores que también puedan realizar esas acciones, por eso vamos a llamar a la política <code>canAdminUser</code>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>/api/policies/canAdminUser.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">	<span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
</span><span class="line">		<span class="k">return</span> <span class="nx">next</span><span class="p">();</span>
</span><span class="line">	<span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">forbidden</span><span class="p">(</span><span class="s1">&#39;You are not permitted to perform this action.&#39;</span><span class="p">);</span>
</span><span class="line"><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Además tendremos que actualizar nuestras políticas:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>/config/policies.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="p">[</span><span class="err">…</span><span class="p">]</span>
</span><span class="line"><span class="nx">UserController</span><span class="o">:</span> <span class="p">{</span>
</span><span class="line">	<span class="s1">&#39;*&#39;</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;isAuthenticated&#39;</span><span class="p">,</span> <span class="s1">&#39;canAdminUser&#39;</span><span class="p">],</span>
</span><span class="line">	<span class="nx">find</span><span class="o">:</span> <span class="s1">&#39;isAuthenticated&#39;</span><span class="p">,</span>
</span><span class="line">	<span class="nx">update</span><span class="o">:</span> <span class="s1">&#39;isAuthenticated&#39;</span><span class="p">,</span>
</span><span class="line">	<span class="nx">logout</span><span class="o">:</span> <span class="s1">&#39;isAuthenticated&#39;</span><span class="p">,</span>
</span><span class="line">	<span class="nx">create</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class="line">	<span class="k">new</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class="line">	<span class="nx">auth</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class="line">	<span class="nx">login</span><span class="o">:</span> <span class="kc">true</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="p">[</span><span class="err">…</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Ahora si intentamos editar o eliminar un usuario no podremos. Así que deberíamos quitar los botones de la interfaz de usuario para reducir la generación de errores. Por lo que añadimos este condicional para mostrar las opciones sólo en caso necesario.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>/views/user/find.ejs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="html"><span class="line">[…]
</span><span class="line"><span class="err">&lt;</span>%
</span><span class="line">if ( session.user.id === user.id ) {
</span><span class="line">// There logged user and showed user is the same.
</span><span class="line">%&gt;
</span><span class="line"><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/user/destroy/&lt;%= user.id %&gt;&quot;</span> <span class="na">method=</span><span class="s">&quot;POST&quot;</span><span class="nt">&gt;</span>[…]<span class="nt">&lt;/form&gt;</span>
</span><span class="line"><span class="err">&lt;</span>% } %&gt;
</span><span class="line">[…]
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Una solución más elegante para no tener que aplicar esta lógica en la template sería utilizar la variable session.canAdminUser. Una forma más elegante, que delega la responsibilidad de la lógica al controlador, que es quien lo debe hacer.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>find action in UserController.js </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">find</span><span class="o">:</span> <span class="p">{</span>
</span><span class="line">	<span class="p">[</span><span class="err">…</span><span class="p">]</span>
</span><span class="line">	<span class="k">if</span> <span class="p">(</span> <span class="nx">isShortcut</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">();</span>
</span><span class="line">
</span><span class="line">	<span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">canAdminUser</span> <span class="o">=</span> <span class="nx">canAdminUser</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">	<span class="p">[</span><span class="err">…</span><span class="p">]</span>
</span><span class="line">
</span><span class="line">	<span class="kd">function</span> <span class="nx">canAdminUser</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">sessionUser</span><span class="p">){</span>
</span><span class="line">		<span class="k">return</span> <span class="nx">sessionUser</span> <span class="o">&amp;&amp;</span> <span class="nx">sessionUser</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">id</span><span class="p">;</span>
</span><span class="line">	<span class="p">};</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>De esta forma si cambiamos las políticas de acceso a la página de listado de usuarios nos aseguramos que solo verán las acciones editar y eliminar aquellos que puedan ejecutarlas.</p>

<div class="alert alert-info">
	<p>Commit en GitHub: <a href="https://github.com/jorgecasar/building-realtime-webapp/commit/01a7287d07509d9f90cb440cb6af828847ece9fe">01a7287d07: Can Admin User Policy</a>.</p>
</div>

<div class="alert alert-info">
	<p>Código en GitHub: <a href="https://github.com/jorgecasar/building-realtime-webapp">building-realtime-webapp</a>. Release: <code>auth</code>.</p>
	<p>Entorno de desarrollo en Heroku: <a href="http://building-realtime-webapp-dev.herokuapp.com/">building-realtime-webapp</a>.</p>
</div>
</div>


      <footer>
        <p class="meta text-muted">
          
  

<span class="glyphicon glyphicon-user"></span> <span class="byline author vcard">Posted by <span class="fn">Jorge del Casar</span></span>

          












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2014-01-18T12:40:04+01:00" pubdate data-updated="true">Jan 18<span>th</span>, 2014</time>
          

<span class="glyphicon glyphicon-tags"></span>&nbsp;
<span class="categories">
  
    <a class='category' href='/blog/categories/sailsjs/'>SailsJS</a>
  
</span>


        </p>
        
          <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://jorgecasar.github.io/blog/desarrollar-webapps-realtime-auth/" data-via="jorgecasar" data-counturl="http://jorgecasar.github.io/blog/desarrollar-webapps-realtime-auth/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

        
        
          <ul class="meta text-muted pager">
            
            <li class="previous"><a href="/blog/desarrollar-webapps-realtime-usuarios/" title="Previous Post: Desarrollar Webapps Realtime: Usuarios">&laquo; Desarrollar Webapps Realtime: Usuarios</a></li>
            
            
            <li class="next"><a href="/blog/desarrollar-webapps-realtime-auth-con-passport/" title="Next Post: Desarrollar Webapps Realtime: Auth con Passport">Desarrollar Webapps Realtime: Auth con Passport &raquo;</a></li>
            
          </ul>
        
      </footer>
    </article>
    
      <section>
        <h1>Comments</h1>
        <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
      </section>
    
  </div>

  
  <aside class="sidebar col-md-3">
    
      <section class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Recent Posts</h3>
  </div>
  
  <div id="recent_posts" class="list-group">
    
    <a class="list-group-item " href="/blog/desarrollar-webapps-realtime-auth-con-passport-y-proveedores/">Desarrollar Webapps Realtime: Auth Con Passport Y Proveedores</a>
    
    <a class="list-group-item " href="/blog/desarrollar-webapps-realtime-auth-con-passport/">Desarrollar Webapps Realtime: Auth Con Passport</a>
    
    <a class="list-group-item active" href="/blog/desarrollar-webapps-realtime-auth/">Desarrollar Webapps Realtime: Auth</a>
    
    <a class="list-group-item " href="/blog/desarrollar-webapps-realtime-usuarios/">Desarrollar Webapps Realtime: Usuarios</a>
    
    <a class="list-group-item " href="/blog/desarrollar-webapps-realtime-creacion/">Desarrollar Webapps Realtime: Creación</a>
    
  </div>
</section>

<section class="panel panel-default clearfix">
  <div class="panel-heading">
      <h3 class="panel-title">GitHub Repos</h3>
  </div>
  <div class="list-group" id="gh_repos">
    <p class="loading">Status updating...</p>
  </div>
  
    <div class="gh-profile-link pull-right text-muted">
      <a href="https://github.com/jorgecasar">@jorgecasar</a> on GitHub
    </div>
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'jorgecasar',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">On Delicious</h3>
  </div>
  <div class="panel-body">
    <div id="delicious"></div>
    <script type="text/javascript" src="http://feeds.delicious.com/v2/json/jorgecasar?count=3&amp;sort=date&amp;callback=renderDeliciousLinks"></script>
    <p><a href="http://delicious.com/jorgecasar">My Delicious Bookmarks &raquo;</a></p>
  </div>
</section>



<section class="googleplus panel panel-default">
  <div class="panel-body">
    <h1>
      <a href="https://plus.google.com/+JorgeDelCasarSanchez?rel=author">
        <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
        Google+
      </a>
    </h1>
  </div>
</section>



    
  </aside>
  
</div>

        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <p class="text-muted credits">
  Copyright &copy; 2014 - Jorge del Casar<br>
  <small>
      <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>,
      <span class="credit">customized with <a href="https://github.com/kAworu/octostrap3">octostrap3</a></span>.
  </small>
</p>

</div>
</footer>
    <script src="/assets/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/javascripts/modernizr-2.0.js"></script>


<script type="text/javascript">
      var disqus_shortname = 'jorgecasar';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://jorgecasar.github.io/blog/desarrollar-webapps-realtime-auth/';
        var disqus_url = 'http://jorgecasar.github.io/blog/desarrollar-webapps-realtime-auth/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





  </body>
</html>
