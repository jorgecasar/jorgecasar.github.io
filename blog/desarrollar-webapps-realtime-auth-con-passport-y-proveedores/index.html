<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Desarrollar Webapps Realtime: Auth con Passport y proveedores - Jorge del Casar</title>
  <meta name="author" content="Jorge del Casar">

  
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://jorgecasar.github.io/blog/desarrollar-webapps-realtime-auth-con-passport-y-proveedores">
  <link href="/favicon.png" type="image/png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="Jorge del Casar" type="application/atom+xml">

  <link href="/assets/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/assets/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css">
<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">


  <script src="/javascripts/libs/jquery/jquery-2.0.3.min.js"></script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-26360643-5']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

  <body   >
    <div id="wrap">
      <header role="banner">
        <nav class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Jorge del Casar</a>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li class="active">
                    <a href="/">Blog</a>
                </li>
                <li >
                    <a href="/blog/archives">Archives</a>
                </li>
                <li >
                    <a href="/repos">Repos</a>
                </li>
                <li >
                    <a href="/talks">Talks</a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a class="subscribe-rss" href="/atom.xml" title="subscribe via RSS">
                        <span class="visible-xs">RSS</span>
                        <img class="hidden-xs" src="/images/rss.png" alt="RSS">
                    </a>
                </li>
                
            </ul>
            
                <form class="search navbar-form navbar-right" action="http://google.com/search" method="GET">
                    <input type="hidden" name="q" value="site:jorgecasar.github.io">
                    <div class="form-group">
                        <input class="form-control" type="text" name="q" placeholder="Search">
                    </div>
                </form>
            
        </div>
    </div>
</nav>


      </header>
      <div id="main" class="container">
        <div id="content">
          <div class="row">
  <div class="page-content col-md-9">
    <article class="hentry" role="article">
      
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2014-01-22T10:13:37+01:00" pubdate data-updated="true">Jan 22<span>nd</span>, 2014</time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="http://jorgecasar.github.io">Comments</a>
        
      </p>
    
    
    <h1 class="entry-title">
        Desarrollar Webapps Realtime: Auth Con Passport Y Proveedores
        
    </h1>
    
  </header>


<div class="entry-content clearfix"><div class="alert alert-info">
	<p>Código en GitHub: <a href="https://github.com/jorgecasar/building-realtime-webapp">building-realtime-webapp</a>. Release: <code>auth-passport-providers</code>.</p>
	<p>Entorno de desarrollo en Heroku: <a href="http://building-realtime-webapp-dev.herokuapp.com/">building-realtime-webapp</a>.</p>
</div>

<p><img class="center" src="http://sailsjs.org/images/image_squidhome.png" title="Designed for developers by Giant Squid" alt="Giant Squid" /></p>

<ul id="markdown-toc">
  <li><a href="#instalar-y-configurar-dependencias">Instalar y configurar dependencias</a>    <ul>
      <li><a href="#fichero-de-configuracin">Fichero de configuración</a></li>
      <li><a href="#servicio-con-extrategias-externas">Servicio con extrategias externas</a></li>
    </ul>
  </li>
  <li><a href="#modificar-modelo-user">Modificar Modelo <code>User</code></a></li>
  <li><a href="#modificaciones-en-usercontroller">Modificaciones en <code>UserController</code></a></li>
  <li><a href="#personalizacin-de-rutas">Personalización de rutas</a>    <ul>
      <li><a href="#formulario-de-autenticacin">Formulario de autenticación</a></li>
      <li><a href="#nuevo-usuario">Nuevo usuario</a></li>
      <li><a href="#mostrar-usuario">Mostrar usuario</a></li>
    </ul>
  </li>
</ul>

<p>Tras ver <a href="/blog/desarrollar-webapps-realtime-auth/">cómo implementar un sistema de autenticación básica</a> y <a href="/blog/desarrollar-webapps-realtime-auth-con-passport/">cómo utilziar Passport para autenticar usuarios</a> vamos a dar un poso más y ver cómo autenticar usuarios usando otros proveedores como Github, Facebook o Twitter.</p>

<!-- more -->

<h2 id="instalar-y-configurar-dependencias">Instalar y configurar dependencias</h2>

<p>Como hemos dicho Passport es un sistema de autenticación modular y nos permite ir ampliando las formas de autenticar a nuestros usuarios. Puedes consultar la <a href="http://passportjs.org/guide/providers/">lista de proveedores de Passport</a> para ver todos los que están disponibles. Instalamos los paquetes que necesitemos:</p>

<pre><code>npm install --save passport-github passport-facebook passport-twitter
</code></pre>

<p>Una vez instalado los paquetes tenemos que configurar las estrategias. Como no quería depender de variables de entorno en local ni exponer las credenciales OAuth en un fichero de configuración, sin mencionar que necesitaremos credenciales diferentes para local y para producción. Por estas razones la solución que os planteo puede ser un poco rebuscada, pero por internet podéis encontrar formas más sencillas si no vais a hacer público vuestro código o decidis depender de variables de entorno.</p>

<h3 id="fichero-de-configuracin">Fichero de configuración</h3>

<p>Lo primero sería pensar en modificar el fichero de configuración. Pero hemos decidido dejar la configuración básica en este fichero y la declaración de estartegias externas en un servicio, debido a la necesidad de usar las variables de configuración de Sails (<code>sails.config</code>). Dado que la estrategia local funciona de fomra diferente y no requiere variables de configuración la hemos mantenido en el fichero de configuración. Los únicos cambios realizados a <code>/config/passport.js</code> son por temas de experiencia de usuario y para declarar los proveedores, que nos servirán para abstraer los proveedores que empleamos.</p>

<p>Pensando en el flujo de autenticación y que hacer cuando no se encuenta al usuario, independientemente del proveedor utilizado, la mejor solución es llevar al usuario a la página de registro, como veremos en el <code>UserController</code>. Si el usuario ha introducido su usuario (username o email) y contraseña, sería un detalle dejarle ese campo del formulario de registro relleno. Esto nos supone los siguientes cambios en nuestra estrategia local cuando no se encuenta el usuario:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>config/passport.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="p">[</span><span class="err">…</span><span class="p">]</span>
</span><span class="line"><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">	<span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class="line">	<span class="kd">var</span> <span class="nx">re_email</span> <span class="o">=</span> <span class="sr">/^(([^&lt;&gt;()[\]\\.,;:\s@\&quot;]+(\.[^&lt;&gt;()[\]\\.,;:\s@\&quot;]+)*)|(\&quot;.+\&quot;))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/</span><span class="p">;</span>
</span><span class="line">	<span class="nx">user</span><span class="p">[</span><span class="nx">re_email</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">username</span><span class="p">)</span><span class="o">?</span><span class="s1">&#39;email&#39;</span><span class="o">:</span><span class="s1">&#39;username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">username</span><span class="p">;</span>
</span><span class="line">	<span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">user</span><span class="p">,</span> <span class="p">{</span> <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;Unknown user &#39;</span> <span class="o">+</span> <span class="nx">username</span> <span class="p">});</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="p">[</span><span class="err">…</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="servicio-con-extrategias-externas">Servicio con extrategias externas</h3>

<p>Hemos creado un fichero en <code>/api/services/PassportService.js</code>, declarando las dependencias de proveedores de autenticación externos. Además declaramos la función, <code>providersHandler</code>, la cual se ejecutará una vez se haya autenticado en el servidor del proveedor. Esta función tiene como parámetros el token, el tokenSecret, el perfil de usuario y una función de callback que definimos cuando solicitamos la autenticación en nuestro controlador. En <code>providersHandler</code> se suele buscar o crear un usuario nuevo si no se encuentra, pero como nosotros tenemos nuestro sistema de usuarios y vamos a implementar varios proveedores, comprobaremos si el perfil está asociado a alguno de nuestros usuarios. Si el id del perfil está en nuestro Modelo devolvemos el usuario, en caso contraro, creamos un usuario un <strong>usuario temporal</strong> (sin guardarlo en la base de datos). Este usuario lo pasaremos al controlador mediante la función de callback para mantenerlo mientras el usuario termina de registrarse en nuestra plataforma y así poder asociar el perfil recibido sin necesidad de solicitar de nuevo la autenticación al proveedor.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>/api/services/PassportService.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="kd">var</span> <span class="nx">passport</span>         <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;passport&#39;</span><span class="p">),</span>
</span><span class="line">    <span class="nx">GitHubStrategy</span>   <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;passport-github&#39;</span><span class="p">).</span><span class="nx">Strategy</span><span class="p">,</span>
</span><span class="line">    <span class="nx">FacebookStrategy</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;passport-facebook&#39;</span><span class="p">).</span><span class="nx">Strategy</span><span class="p">,</span>
</span><span class="line">    <span class="nx">TwitterStrategy</span>  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;passport-twitter&#39;</span><span class="p">).</span><span class="nx">Strategy</span><span class="p">;</span>
</span><span class="line">
</span><span class="line"><span class="kd">function</span> <span class="nx">providersHandler</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">tokenSecret</span><span class="p">,</span> <span class="nx">profile</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">sails</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">verbose</span><span class="p">(</span><span class="s1">&#39;config/passport providersHandler&#39;</span><span class="p">);</span>
</span><span class="line">	<span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">()</span>
</span><span class="line">		<span class="p">.</span><span class="nx">where</span><span class="p">({</span><span class="s1">&#39;profiles.id&#39;</span><span class="o">:</span> <span class="nx">profile</span><span class="p">.</span><span class="nx">id</span><span class="p">})</span>
</span><span class="line">		<span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">			<span class="k">if</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
</span><span class="line">			
</span><span class="line">			<span class="kd">var</span> <span class="nx">tempUser</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class="line">			<span class="nx">tempUser</span><span class="p">.</span><span class="nx">profiles</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class="line">			<span class="p">[</span><span class="err">…</span><span class="p">]</span>
</span><span class="line">			<span class="nx">tempUser</span><span class="p">.</span><span class="nx">profiles</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">profile</span><span class="p">);</span>
</span><span class="line">			<span class="k">delete</span> <span class="nx">profile</span><span class="p">.</span><span class="nx">_raw</span><span class="p">;</span>
</span><span class="line">			<span class="k">delete</span> <span class="nx">profile</span><span class="p">.</span><span class="nx">_json</span><span class="p">;</span>
</span><span class="line">			<span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">tempUser</span><span class="p">);</span>
</span><span class="line">		<span class="p">});</span>
</span><span class="line">	<span class="p">});</span>
</span><span class="line"><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Por último, el servicio exporta un módulo con una función que configura los proveedores con las variables de entorno o las de configuración de sails. Lo hacemos dentro de una función para disponer del objeto <code>sails</code> y por tanto de la configuración declarada en <code>/config/local.js</code> (hay una copia de referencia en <code>/config/local.ex.js</code>). Estas propiedades y métodos estarán disponibles en `sails.config</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>/api/services/PassportService.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">configProviders</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">passport</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="k">new</span> <span class="nx">GitHubStrategy</span><span class="p">(</span>
</span><span class="line">			<span class="p">{</span>
</span><span class="line">				<span class="nx">clientID</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">GITHUB_CLIENT_ID</span> <span class="o">||</span> <span class="nx">sails</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">providers</span><span class="p">.</span><span class="nx">github</span><span class="p">.</span><span class="nx">clientID</span><span class="p">,</span>
</span><span class="line">				<span class="nx">clientSecret</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">GITHUB_CLIENT_SECRET</span> <span class="o">||</span> <span class="nx">sails</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">providers</span><span class="p">.</span><span class="nx">github</span><span class="p">.</span><span class="nx">clientSecret</span><span class="p">,</span>
</span><span class="line">				<span class="nx">callbackURL</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">GITHUB_CALLBACK_URL</span> <span class="o">||</span> <span class="nx">sails</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">providers</span><span class="p">.</span><span class="nx">github</span><span class="p">.</span><span class="nx">callbackURL</span><span class="p">,</span>
</span><span class="line">			<span class="p">},</span>
</span><span class="line">			<span class="nx">providersHandler</span>
</span><span class="line">		<span class="p">));</span>
</span><span class="line">		<span class="nx">passport</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="k">new</span> <span class="nx">FacebookStrategy</span><span class="p">({</span>
</span><span class="line">				<span class="p">[</span><span class="err">…</span><span class="p">]</span>
</span><span class="line">			<span class="p">},</span>
</span><span class="line">			<span class="nx">providersHandler</span>
</span><span class="line">		<span class="p">));</span>
</span><span class="line">		<span class="nx">passport</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="k">new</span> <span class="nx">TwitterStrategy</span><span class="p">({</span>
</span><span class="line">				<span class="p">[</span><span class="err">…</span><span class="p">]</span>
</span><span class="line">			<span class="p">},</span>
</span><span class="line">			<span class="nx">providersHandler</span>
</span><span class="line">		<span class="p">));</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line"><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Esta nueva función, <code>configProviders</code> debemos llamarla al iniciar la aplicaicón para que se configuren nuestros proveedores de autenticación. Para ello incluimos la llamada en <code>/config/bootstrap.js</code>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>/config/bootstrap.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">bootstrap</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">PassportService</span><span class="p">.</span><span class="nx">configProviders</span><span class="p">();</span>
</span><span class="line">	<span class="nx">next</span><span class="p">();</span>
</span><span class="line"><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="modificar-modelo-user">Modificar Modelo <code>User</code></h2>

<p>En el modelo solo tendremos que añadir un atributo más que guarde los perfiles del usuario. Los resultados se normalizan siguiendo el esquema de contacto establecido por Portable Contacts y puedes consultar en el <a href="http://passportjs.org/guide/profile/">perfil de usuario en Passport</a>. De momento Sails no permite las asociaciones, disponibles en la versión 0.10, así definiremos un array y procuraremos mantener el schema. Cuando pasemos a Sails.js 0.10 implementaremos asociaciones las cuales nos permitirán crear un modelo Profile en el que definieremos este schema.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>/api/models/User.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">attributes</span><span class="o">:</span> <span class="p">{</span>
</span><span class="line">		<span class="p">[</span><span class="err">…</span><span class="p">]</span>
</span><span class="line">		<span class="nx">profiles</span><span class="o">:</span> <span class="p">{</span>
</span><span class="line">			<span class="s1">&#39;array&#39;</span><span class="p">,</span>
</span><span class="line">			<span class="nx">defaultsTo</span><span class="o">:</span> <span class="p">[]</span>
</span><span class="line">		<span class="p">}</span>
</span><span class="line">		<span class="c1">// Profiles object look like this:</span>
</span><span class="line">		<span class="c1">// provider: &#39;string&#39;,</span>
</span><span class="line">		<span class="c1">// id: &#39;string&#39;,</span>
</span><span class="line">		<span class="c1">// displayName: &#39;string&#39;,</span>
</span><span class="line">		<span class="c1">// name_familyName: &#39;string&#39;,</span>
</span><span class="line">		<span class="c1">// name_givenName: &#39;string&#39;,</span>
</span><span class="line">		<span class="c1">// name_middleName: &#39;string&#39;,</span>
</span><span class="line">		<span class="c1">// emails: &#39;array&#39;,</span>
</span><span class="line">		<span class="c1">// photos: &#39;array&#39;</span>
</span><span class="line">		<span class="p">[</span><span class="err">…</span><span class="p">]</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line"><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="modificaciones-en-usercontroller">Modificaciones en <code>UserController</code></h2>

<p>Vamos a ampliar la funcionalidad de las acciones <code>login</code> y <code>logout</code>, las cuales nos permitirán realizar el login de un usuario y unir un perfil con el usuario registrado. Obtenemos el proveedor por parámetro (ver <a href="#personalizacin-de-rutas">Personalización de rutas</a>) y si es válido procederemos a la unión o eliminación del perfil. La url a la que haremos las peticiones será del tipo <code>/user/login/github</code>, siendo <code>github</code> lo que recibiremos como parámetro <code>provider</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>/api/controllers/UserController.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">login</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">	<span class="kd">var</span> <span class="nx">provider</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;provider&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="s1">&#39;local&#39;</span><span class="p">;</span>
</span><span class="line">	<span class="k">if</span> <span class="p">(</span> <span class="nx">provider</span> <span class="o">===</span> <span class="s1">&#39;local&#39;</span> <span class="o">||</span> <span class="nx">isProvider</span><span class="p">(</span><span class="nx">provider</span><span class="p">)</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">linkProfile</span><span class="p">(</span><span class="nx">provider</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">);</span>
</span><span class="line">	<span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/auth&#39;</span><span class="p">);</span>
</span><span class="line"><span class="p">},</span>
</span><span class="line"><span class="nx">logout</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
</span><span class="line">	<span class="kd">var</span> <span class="nx">provider</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;provider&#39;</span><span class="p">);</span>
</span><span class="line">	<span class="k">if</span> <span class="p">(</span> <span class="nx">isProvider</span><span class="p">(</span><span class="nx">provider</span><span class="p">)</span> <span class="p">)</span> <span class="k">return</span> <span class="nx">unlinkProfile</span><span class="p">(</span><span class="nx">provider</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">);</span>
</span><span class="line">	<span class="nx">req</span><span class="p">.</span><span class="nx">logout</span><span class="p">();</span>
</span><span class="line">	<span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Esto unido a tres funciones auxiliares resuelven de manera bastante elegante la autenticación de usuarios, enlace y desenlace de perfiles. La primera función auxiliar, <code>isProvider</code>, es para comprobar si es un proveedor de authenticación válido.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>/api/controllers/UserController.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="kd">function</span> <span class="nx">isProvider</span><span class="p">(</span><span class="nx">id</span><span class="p">){</span>
</span><span class="line">	<span class="k">return</span> <span class="nx">sails</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">providers</span><span class="p">[</span><span class="nx">provider</span><span class="p">];</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>La segunda, <code>linkProfile</code>, es la encargada de gestionar el login con dicho proveedor. Tendrá en cuenta si el usuario está registrado, si hemos encontrado un usuario con dicho perfil en nuestra base de datos y actuará en consecuencia en cada uno de los 5 casos:</p>

<ol>
  <li>Usuario registrado, intenta enlazar de nuevo un perfil ya enlazado.</li>
  <li>Usuario registrado, intenta enlazar un perfil asociado a otro usuario.</li>
  <li>Usuario registrado, intenta enlazar un perfil no asociado a ningún usuario.</li>
  <li>Usuario no registrado, se autentica con un perfil asociado a su usuario.</li>
  <li>Usuario no registrado, se autentica con un perfil no asociado a ningún usuario.</li>
</ol>

<h2 id="personalizacin-de-rutas">Personalización de rutas</h2>

<p>Un fichero que no habíamos visto hasta hora <code>/config/routes.js</code> hace aparición para que definamos las url de <code>login</code> y <code>logout</code>. El indicar en la url <code>:provider</code> establecemos <code>provider</code> como un parámetro y con <code>?</code> lo hacemos opcional. De esta forma estas urls nos sirven para el login general y para el login con un proveedor concreto.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>/config/routes.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">routes</span> <span class="o">=</span> <span class="p">{</span>
</span><span class="line">	<span class="s1">&#39;/&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class="line">		<span class="nx">view</span><span class="o">:</span> <span class="s1">&#39;home/index&#39;</span>
</span><span class="line">	<span class="p">},</span>
</span><span class="line">	<span class="s1">&#39;/user/login/:provider?&#39;</span><span class="o">:</span> <span class="s1">&#39;UserController.login&#39;</span><span class="p">,</span>
</span><span class="line">	<span class="s1">&#39;/user/logout/:provider?&#39;</span><span class="o">:</span> <span class="s1">&#39;UserController.logout&#39;</span>
</span><span class="line"><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>## Cambios en las vistas</p>

<p>Ya tenemos toda la parte de lógica de negocio lista. Todo lo que hemos realizado en los controladores, modelos, cofig, servicios… tenemos que refejarlo en las vistas así que vamos a listar los cambios que hay que realizar.</p>

<h3 id="formulario-de-autenticacin">Formulario de autenticación</h3>

<ul>
  <li>Renombramos el fichero <code>/view/user/auth.ejs</code> a <code>/view/auth/index.ejs</code>.</li>
  <li>Cambiamos el action del formulario de autenticación a <code>/auth/login/local</code>.</li>
  <li>Añadimos los botones de autenticación de los diferentes proveedores que vamos a utilizar como formularios con action <code>/auth/login/[provider]</code>, siendo <code>[provider]</code> el proveedor que corresponda en cada caso. Para ello utilizamos utilizamos la variable <code>sails.config.providers</code> y un bucle <code>each</code>:</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>views/user/auth.ejs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="html"><span class="line"><span class="err">&lt;</span>% if ( sails.config.providers ) { %&gt;
</span><span class="line"><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;form-center&quot;</span><span class="nt">&gt;</span>
</span><span class="line">	<span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">&quot;text-center&quot;</span><span class="nt">&gt;</span><span class="err">&lt;</span>%= __(&#39;or Auth with...&#39;) %&gt;<span class="nt">&lt;p&gt;</span>
</span><span class="line">	<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
</span><span class="line">		<span class="err">&lt;</span>% _.each(sails.config.providers, function(provider, provider_id){ %&gt;
</span><span class="line">		<span class="nt">&lt;form</span> <span class="na">role=</span><span class="s">&quot;form&quot;</span> <span class="na">action=</span><span class="s">&quot;/user/login/&lt;%= provider_id %&gt;&quot;</span> <span class="na">method=</span><span class="s">&quot;POST&quot;</span> <span class="na">class=</span><span class="s">&quot;col-xs-4&quot;</span><span class="nt">&gt;</span>
</span><span class="line">			<span class="nt">&lt;p&gt;</span>
</span><span class="line">				<span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">class=</span><span class="s">&quot;btn btn-primary btn-block&quot;</span><span class="nt">&gt;</span>
</span><span class="line">					<span class="c">&lt;!--span class=&quot;glyphicon glyphicon-&lt;%= provider_id %&gt;&quot;&gt;&lt;/span--&gt;</span>
</span><span class="line">					<span class="err">&lt;</span>%= __(provider_id) %&gt;
</span><span class="line">				<span class="nt">&lt;/button&gt;</span>
</span><span class="line">			<span class="nt">&lt;/p&gt;</span>
</span><span class="line">		<span class="nt">&lt;/form&gt;</span>
</span><span class="line">		<span class="err">&lt;</span>% }) %&gt;
</span><span class="line">	<span class="nt">&lt;/div&gt;</span>
</span><span class="line"><span class="nt">&lt;/div&gt;</span>
</span><span class="line"><span class="err">&lt;</span>% } %&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="nuevo-usuario">Nuevo usuario</h3>

<p>Como hemos comentado guardamos un usuario temporal cuando no hemos encontrado el usuario en nuestra base de datos. Este es el momento de mostrarle al usuario los datos que había rellenado al intentar autenticarse. Hemos omitido poner la contraseña, porque es mejor introducirla de manera consciente. Este sería un ejemplo de como introducimos el valor del usuario temporal.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>views/user/new.ejs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="html"><span class="line"><span class="nt">&lt;input</span>
</span><span class="line">	<span class="na">type=</span><span class="s">&quot;text&quot;</span>
</span><span class="line">	<span class="na">class=</span><span class="s">&quot;form-control&quot;</span>
</span><span class="line">	<span class="na">placeholder=</span><span class="s">&quot;&lt;%= __(&#39;Username&#39;) %&gt;&quot;</span>
</span><span class="line">	<span class="na">name=</span><span class="s">&quot;username&quot;</span>
</span><span class="line">	<span class="na">id=</span><span class="s">&quot;username&quot;</span>
</span><span class="line">	<span class="na">required</span>
</span><span class="line">	<span class="err">&lt;%</span> <span class="na">if</span><span class="err">(</span> <span class="na">session</span><span class="err">.</span><span class="na">tempUser</span> <span class="err">&amp;&amp;</span> <span class="na">session</span><span class="err">.</span><span class="na">tempUser</span><span class="err">.</span><span class="na">username</span> <span class="err">)</span> <span class="err">{</span> <span class="err">%</span><span class="nt">&gt;</span>
</span><span class="line">	value=&quot;<span class="err">&lt;</span>%= session.tempUser.username %&gt;&quot;
</span><span class="line">	<span class="err">&lt;</span>% } %&gt;/&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="mostrar-usuario">Mostrar usuario</h3>

<p>En la vista del usuario ahora tendremos que informarle de qué perfiles ha unido a su cuenta y darle la posibilidad de unir nuevos o eliminar los que tenga unidos. Así que iteramos los proveedores, <code>sails.config.providers</code> y si encontramos un perfil de ese proveedor entre los perfiles del usuario ofrecemos la opción de eliminar y en caso contrario la de añadir. Solo vamos a mostrar el condicional para mostrar el uso del método find:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>views/user/find.ejs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="html"><span class="line"><span class="err">&lt;</span>% if( _.find(
</span><span class="line">	user.profiles,
</span><span class="line">	function(profile) {
</span><span class="line">		return profile.provider == provider_id;
</span><span class="line">	}
</span><span class="line">) ) { %&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Con esto hemos terminado nuestro sistema de autenticación con proveedores externos y creado un sistema que facilita el deshabilitar o habilitar nuevos sistemas de autenticación.</p>

<div class="alert alert-info">
	<p>Commit en GitHub: <a href="https://github.com/jorgecasar/building-realtime-webapp/commit/c3e544e2ca9a890151959129f347667d43eb5209">c3e544e2ca: Auth with Passport and providers (GitHub, Facebook, Twitter).</a></p>
	<p>Commit en GitHub: <a href="https://github.com/jorgecasar/building-realtime-webapp/commit/7eb75b35f1c878bb1f94039edb94ced5f7c7913b">7eb75b35f1: Delete verb from login and logout routes.</a></p>
	<p>Commit en GitHub: <a href="https://github.com/jorgecasar/building-realtime-webapp/commit/0f78d3898b16702750d99a536434310ab3058a4f">0f78d3898b: Update read me and index to show read me info.</a></p>
</div>

<div class="alert alert-info">
	<p>Código en GitHub: <a href="https://github.com/jorgecasar/building-realtime-webapp">building-realtime-webapp</a>. Release: <code>auth-passport-providers</code>.</p>
	<p>Entorno de desarrollo en Heroku: <a href="http://building-realtime-webapp-dev.herokuapp.com/">building-realtime-webapp</a>.</p>
</div>

</div>


      <footer>
        <p class="meta text-muted">
          
  

<span class="glyphicon glyphicon-user"></span> <span class="byline author vcard">Posted by <span class="fn">Jorge del Casar</span></span>

          












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2014-01-22T10:13:37+01:00" pubdate data-updated="true">Jan 22<span>nd</span>, 2014</time>
          

<span class="glyphicon glyphicon-tags"></span>&nbsp;
<span class="categories">
  
    <a class='category' href='/blog/categories/sailsjs/'>SailsJS</a>
  
</span>


        </p>
        
          <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://jorgecasar.github.io/blog/desarrollar-webapps-realtime-auth-con-passport-y-proveedores/" data-via="jorgecasar" data-counturl="http://jorgecasar.github.io/blog/desarrollar-webapps-realtime-auth-con-passport-y-proveedores/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

        
        
          <ul class="meta text-muted pager">
            
            <li class="previous"><a href="/blog/desarrollar-webapps-realtime-auth-con-passport/" title="Previous Post: Desarrollar Webapps Realtime: Auth con Passport">&laquo; Desarrollar Webapps Realtime: Auth con Passport</a></li>
            
            
          </ul>
        
      </footer>
    </article>
    
      <section>
        <h1>Comments</h1>
        <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
      </section>
    
  </div>

  
  <aside class="sidebar col-md-3">
    
      <section class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Recent Posts</h3>
  </div>
  
  <div id="recent_posts" class="list-group">
    
    <a class="list-group-item active" href="/blog/desarrollar-webapps-realtime-auth-con-passport-y-proveedores/">Desarrollar Webapps Realtime: Auth Con Passport Y Proveedores</a>
    
    <a class="list-group-item " href="/blog/desarrollar-webapps-realtime-auth-con-passport/">Desarrollar Webapps Realtime: Auth Con Passport</a>
    
    <a class="list-group-item " href="/blog/desarrollar-webapps-realtime-auth/">Desarrollar Webapps Realtime: Auth</a>
    
    <a class="list-group-item " href="/blog/desarrollar-webapps-realtime-usuarios/">Desarrollar Webapps Realtime: Usuarios</a>
    
    <a class="list-group-item " href="/blog/desarrollar-webapps-realtime-creacion/">Desarrollar Webapps Realtime: Creación</a>
    
  </div>
</section>

<section class="panel panel-default clearfix">
  <div class="panel-heading">
      <h3 class="panel-title">GitHub Repos</h3>
  </div>
  <div class="list-group" id="gh_repos">
    <p class="loading">Status updating...</p>
  </div>
  
    <div class="gh-profile-link pull-right text-muted">
      <a href="https://github.com/jorgecasar">@jorgecasar</a> on GitHub
    </div>
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'jorgecasar',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">On Delicious</h3>
  </div>
  <div class="panel-body">
    <div id="delicious"></div>
    <script type="text/javascript" src="http://feeds.delicious.com/v2/json/jorgecasar?count=3&amp;sort=date&amp;callback=renderDeliciousLinks"></script>
    <p><a href="http://delicious.com/jorgecasar">My Delicious Bookmarks &raquo;</a></p>
  </div>
</section>



<section class="googleplus panel panel-default">
  <div class="panel-body">
    <h1>
      <a href="https://plus.google.com/+JorgeDelCasarSanchez?rel=author">
        <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
        Google+
      </a>
    </h1>
  </div>
</section>



    
  </aside>
  
</div>

        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <p class="text-muted credits">
  Copyright &copy; 2014 • Jorge del Casar • Desarrollo HTML5, JavaScript and móvil.<br>
  <small>
      <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>,
      <span class="credit">customized with <a href="https://github.com/kAworu/octostrap3">octostrap3</a></span>.
  </small>
</p>

</div>
</footer>
    <script src="/assets/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/javascripts/modernizr-2.0.js"></script>


<script type="text/javascript">
      var disqus_shortname = 'jorgecasar';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://jorgecasar.github.io/blog/desarrollar-webapps-realtime-auth-con-passport-y-proveedores/';
        var disqus_url = 'http://jorgecasar.github.io/blog/desarrollar-webapps-realtime-auth-con-passport-y-proveedores/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





  </body>
</html>
